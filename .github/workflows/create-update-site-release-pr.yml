
name: DBeaver Release - Create Update Site Repo PR

on:
  release:
    types: [created]      # Runs when you create a GitHub release
  pull_request:
    branches: [ main ]    # TODO REMOVE Runs when PR is opened/updated targeting main branch
  workflow_dispatch:      # Runs when you manually click "Run workflow" button

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Build JARs
        run: mvn clean install -P jars

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AURORA_DSQL_DBEAVER_PLUGIN_IAM_ROLE }}
          aws-region: ${{ secrets.AURORA_DSQL_DBEAVER_PLUGIN_SIGNER_REGION }}
      
      - name: Upload JARs to S3
        run: |
          find . -path "*/target/*.jar" -type f -exec bash -c '
            FILENAME=$(basename "$0")
            if aws s3 cp "$0" "s3://$S3_BUCKET/$S3_KEY_PREFIX/$FILENAME" --no-progress 2>&1 | grep -q "upload:"; then
              VERSION_ID=$(aws s3api head-object --bucket "$S3_BUCKET" --key "$S3_KEY_PREFIX/$FILENAME" --output json 2>/dev/null | jq -r ".VersionId")
              echo "Uploaded: $FILENAME, VersionId: $VERSION_ID"
            else
              echo "Failed to upload: $FILENAME"
            fi
          ' {} \;
        env:
          S3_BUCKET: ${{ secrets.AURORA_DSQL_DBEAVER_PLUGIN_S3_BUCKET }}
          S3_KEY_PREFIX: ${{ secrets.AURORA_DSQL_DBEAVER_PLUGIN_S3_KEY_PREFIX }}


